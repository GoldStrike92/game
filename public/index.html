<!DOCTYPE html>
<html>
  <head>
  	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  	<title>Ping pong</title>
    <script src="socket.io/socket.io.js"></script>
    <script src="shape.js"></script>
    <script src="ball.js"></script>  		

    <script src="jquery.js" type="text/javascript"></script>
    <script src="jquery.easing.1.3.js" type="text/javascript"></script>
    <link href="facebox/facebox.css" media="screen" rel="stylesheet" type="text/css"/>
    <link href="pong.css" media="screen" rel="stylesheet" type="text/css"/>
    <script src="facebox/facebox.js" type="text/javascript"></script>
    <script type="text/javascript" src="http://j.maxmind.com/app/country.js"></script>
  </head>
  <body>
    <div id="score_container">
      <div id="player1_flag">&nbsp;</div>
      <div id="score">0 : 0</div>
      <div id="player2_flag"></div>
    </div>

    <div style="clear:both"></div>

    <div id="player1_arrow" style="display:none"> That's you <img src="images/player1.png" alt="player 1"/></div>

    <div id="canvas_container">
      <canvas id="main_canvas" width="500" height="500"></canvas>
    </div>

    <div id="player2_arrow" style="display:none"><img src="images/player2.png" alt="player 2"/> That's you </div>

    <div id="log"></div>

    <audio preload="auto" autobuffer id="player1_notice_audio">
      <source src="doorbell.mp3" />
    </audio>

    <script type="text/javascript">
  	// <![CDATA[
      $.facebox.settings.closeImage = 'facebox/closelabel.png';
      $.facebox.settings.loadingImage = 'facebox/loading.gif';
      var ctx    = document.getElementById('main_canvas').getContext('2d');

      var TICK_INTERVAL  = 50;

      var CANVAS_HEIGHT  = 500;
      var CANVAS_WIDTH   = 500;

      var SHAPE_WIDTH    = 20;
      var SHAPE_HEIGHT   = 60;
      var BALL_DIAMETER  = 3;
      PLAYER_COLORS  = [null, '#D40000', '#07AF45']

      var current_player_id;
      window.player_shapes = [null];
      var player_id_having_the_ball = 1; // this could vary once the ball went off the canvas / round ended
      var BALL_X_STEP = 5, BALL_Y_STEP = 5;
      var ball;

      window.ball_movement_timer = null, window.shape_movement_timer = null, window.bg_timer = null;

      window.round_could_be_started = false; //player 1 couldn't start if player 2 hadn't been connected
      window.round_started = false; // global to know whether to draw the ball near the shape at the beginning of round
      var player_1_won_rounds = 0;
      var player_2_won_rounds = 0;

      var redraw_all = function() {
        ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
        for(var i = 1; i < 3; i++) { 
          player_shapes[i].draw(); 
        }
        ball.redraw();
      }

      var start_round = function() {
        round_started = true;
        clearInterval(ball_movement_timer);
			  ball_movement_timer = setInterval(function() { ball.move.apply(ball) }, TICK_INTERVAL);  // in order to this.draw work in ball's move() function we use apply here
        ball.initial_shot();

        bg_timer = setInterval(function() {
          var info = {type: 'sync', player_id: current_player_id, position_y: player_shapes[current_player_id].get_y_position(), room_id: window.room_id}
          if(current_player_id == player_id_having_the_ball) {
            var coords = ball.get_coordinates();
            info['ball_x'] = coords.ball_x;
            info['ball_y'] = coords.ball_y;
            info['previous_x'] = coords.previous_x;
            info['previous_y'] = coords.previous_y;
          }
          socket.send(info);
        }, TICK_INTERVAL);
      }

      var finish_round = function(player_won) {
        jQuery.facebox('Player ' + player_won + ' won!');
        setTimeout(function() { jQuery.facebox.close() }, 3000); // automatically close the alert after 3 seconds

        clearInterval(ball_movement_timer);
        clearInterval(bg_timer);
        ball_movement_timer = null;
        bg_timer = null;
        round_started = false;
        round_could_be_started = true;

        if(player_won == 1) {
          player_1_won_rounds += 1;
        } else {
          player_2_won_rounds += 1;
        }

        document.getElementById('score').innerHTML = player_1_won_rounds + ' : ' + player_2_won_rounds;
        ball = new Ball(ctx, window.player_id_having_the_ball, player_shapes[window.player_id_having_the_ball]);
        player_shapes[window.player_id_having_the_ball].set_ball(ball);
        redraw_all();
      }

      var init = function() {
        var current_player_shape = new Shape(ctx, current_player_id);
        var other_player_shape = new Shape(ctx, ((current_player_id == 1) ? 2 : 1));
        if(current_player_id == 1){
          player_shapes.push(current_player_shape);
          player_shapes.push(other_player_shape);
        } else {
          player_shapes.push(other_player_shape);
          player_shapes.push(current_player_shape);
        }

        ball = new Ball(ctx, player_id_having_the_ball, player_shapes[player_id_having_the_ball]);
        player_shapes[player_id_having_the_ball].set_ball(ball);        

        current_player_shape.draw();
        other_player_shape.draw();

        jQuery('#log').html('');
        jQuery('#player' + current_player_id + '_arrow').show().animate({left: (current_player_id == 1 ? '+=100' : '-=100')}, 4000, 'easeOutBounce', function(){ jQuery('#player' + current_player_id + '_arrow').fadeOut(3000)});
        // using here workaround with 38,40 pseudo-ASCII codes (button-up/button-down) to move the shape
        // these buttons generate only onkeydown/onkeyup events (which occur only once) so user should
        // push the button many times in order to constantly move it (one step at a time - really SLOW)
        // the keypressed event (which could handle continiously pressed buttons) doesn't react on special buttons
        // so I'd rather just start a timer with shape.move() function on 'onkeydown' event and clear it on 'onkeyup'
        // (explanation about a mess with keypress/up/down events could be found here: http://unixpapa.com/js/key.html)

			  window.onkeydown = function(e) {
				  if ( e.keyCode == 38 && shape_movement_timer == null) {
            shape_movement_timer = setInterval(function() {
				      if(current_player_shape.can_move({to: 'top'})) {
						    current_player_shape.move({to: 'top'});
                redraw_all();
						  }
            }, TICK_INTERVAL);
					} else if ( e.keyCode == 40 && shape_movement_timer == null) {
            shape_movement_timer = setInterval(function() {
							if(current_player_shape.can_move({to: 'bottom'})) {
								current_player_shape.move({to: 'bottom'});
		            redraw_all();
							}
            }, TICK_INTERVAL);
					} else if (e.keyCode == 32) { // if spacebar pressed - begin round
            if(current_player_id == player_id_having_the_ball && round_could_be_started) {
              start_round();
              var coords = ball.get_coordinates();
							socket.send({type: 'round_started', room_id: window.room_id, ball_x: coords.ball_x, ball_y: coords.ball_y});
            }
          }
        }

        window.onkeyup = function(e) {
          if ( e.keyCode == 38 && shape_movement_timer != null) {
            clearInterval(shape_movement_timer);
            shape_movement_timer = null;
          } else if ( e.keyCode == 40 && shape_movement_timer != null) {
            clearInterval(shape_movement_timer);
            shape_movement_timer = null;
          }
        }
			}

      var socket = new io.Socket(null, {port: 8080, rememberTransport: false, reconnect: true, reconnectionDelay: 100});

			var connected = false;
			const RETRY_INTERVAL = 1000;
			var reconnect_timeout;

			socket.on('connect', function() {
				connected = true;
        jQuery('#log').html('');
				clearTimeout(reconnect_timeout);
			});

      socket.connect();
//retryConnectOnFailure(RETRY_INTERVAL);
      // messages could be 5 types
      // 1. - 1st/2nd player connected
      // 2. - round could be started (so player 1 couldn't start if player 2 hadn't connected yet)
      // 3. - round just began, synchronive initial position of the ball
      // 4. - sync token with current player's ball and racket positions
      // 5. - ball went out of the field / who loose / new round
      // 6. - player in the same room has been disconnected
      socket.on('message', function(obj){
        switch(obj.type) {
          case 'list_of_rooms':
            var img_for_room, is_room_disabled_for_select = '';
            for(var i = 0; i < obj.number_of_rooms; i++) {
              switch(obj.rooms[i].number_of_connected_players) {
                case 0:
                  img_for_room = '<img src="images/green_dot.png" width="12" height="12" alt="Available"/ >';
                  is_room_disabled_for_select = ''
                  break;
                case 1:
                  img_for_room = '<img src="images/yellow_dot.png" width="12" height="11" alt="Available"/ >';
                  is_room_disabled_for_select = ''
                  break;
                case 2:
                  img_for_room = '<img src="images/red_dot.png" width="12" height="11" alt="Full"/ >';
                  is_room_disabled_for_select = 'disabled';
                  break;
              }
              $('#form_for_list_of_rooms').append(img_for_room+'<input type="radio" name="room_id" onclick="window.room_id=parseInt(this.value)" '+is_room_disabled_for_select+' value="' + i + '"> #' + i + " [" + obj.rooms[i].number_of_connected_players + "] players<br/ >");
            }
            $('#form_for_list_of_rooms').append('<input type="submit" value="Connect"/ >');
            jQuery.facebox({ div: '#list_of_rooms' });
            break;
          // if this is 1st player then draw ball near him
          case 'player_connected':
            current_player_id = obj.player_id;
            init();
            // TODO refactor
            if(obj.player_id == 1) {
              jQuery('#player1_flag').html('<img src="country_icons/' + obj.player1_country_code + '.png" width="16" height="11" title="' + obj.player1_country_name + '" alt="' + obj.player1_country_name + '"/ >');
            } else {
              jQuery('#player1_flag').html('<img src="country_icons/' + obj.player1_country_code + '.png" width="16" height="11" title="' + obj.player1_country_name + '" alt="' + obj.player1_country_name + '"/ >');
              jQuery('#player2_flag').html('<img src="country_icons/' + obj.player2_country_code + '.png" width="16" height="11" title="' + obj.player2_country_name + '" alt="' + obj.player2_country_name + '"/ >');
            }
            // and wait till 2nd user connects to the game
            break;
          case 'sync':
					  if(obj.room_id == window.room_id && player_shapes[obj.player_id].can_move({to_pos: obj.position_y})) {
							player_shapes[obj.player_id].move({to_pos: obj.position_y});
              // ball's position is synced to player having the ball in this round
              if(obj.ball_x && obj.ball_y) {
                // second player just corrects position of his ball from player_1's one
                ball.set_coordinates(obj);
              }
              redraw_all();
            }
            break;
          case 'round_could_be_started':
            if(obj.room_id == window.room_id) {
              round_could_be_started = true;
              if(jQuery('#player1_notice_audio')[0].play)
                jQuery('#player1_notice_audio')[0].play();
              jQuery('#player2_flag').html('<img src="country_icons/' + obj.country_code + '.png" alt="' + obj.country_name + '" width="16" height="11" alt="' + obj.country_name + '"/ >');
              jQuery.facebox('Round could be started: please press spacebar to start!');
              setTimeout(function() { jQuery.facebox.close() }, 3000); // automatically close the alert after 3 seconds
            }
            break;
          case 'round_started':
            if(obj.room_id == window.room_id) {
              ball.set_coordinates(obj);
              start_round();
            }
            break;
          case 'end_of_the_round':
            if(obj.room_id == window.room_id) {
              window.player_id_having_the_ball = obj.player_id_having_the_ball;
              finish_round(obj.player_won);
            }
            break;
          case 'disconnect':
            if(obj.room_id == window.room_id) {
              jQuery('#log').html('The your opponent just leaved this room');

              if(round_started)
                finish_round(current_player_id);
            }
            break;
        }        
      });

      var retryConnectOnFailure = function(retryInMilliseconds) {
        setTimeout(function() {
          if (!connected) {
            //jQuery.get('ping', function(data) { connected = true; });
            socket.connect();
            retryConnectOnFailure(retryInMilliseconds);
          }
        }, retryInMilliseconds);
      };

      socket.on('reconnect', function() {
        jQuery('#log').html("<b>Disconnected!</b>");
      });

      socket.on('disconnect', function() {
				connected = false;
				console.log('disconnected');
				//jQuery('#log').html("<b>Disconnected! Trying to automatically to reconnect in " + RETRY_INTERVAL/1000 + " seconds.</b>");
				//retryConnectOnFailure(RETRY_INTERVAL);
			});

      var window_width = jQuery(window).width();
      var player1_arrow_width = jQuery('#player1_arrow').width();
      jQuery('#player1_arrow').css({left: ((window_width / 2) - player1_arrow_width - 350) + 'px'});
      jQuery('#player2_arrow').css({left: ((window_width / 2) + 350) + 'px'});
  	// ]]>
  	</script>

  <div id="list_of_rooms" style="display:none">
    <h3>Please select to which room you want to connect:</h3>
    <form id="form_for_list_of_rooms" onsubmit="if(typeof window.room_id != 'undefined') {$('#errors_for_list_of_rooms').hide(); socket.send({type: 'connect', room_id: window.room_id, country_code: geoip_country_code().toLowerCase(), country_name: geoip_country_name()}); jQuery.facebox.close();} else {$('#errors_for_list_of_rooms').show(); jQuery.facebox({ div: '#list_of_rooms' });}; return false;"></form>
    <div id="errors_for_list_of_rooms" style="color:red;font-size:16px;float:left;display:none">You should specify which room do you want to play in</div>
  </div>
  </body>
</html>
